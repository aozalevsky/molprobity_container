Bootstrap: docker
From: ubuntu:22.04
Stage: spython-base

%arguments
    
    NPROC=8

%labels

    MAINTAINER Arthur Zalevsky <aozalevsky@gmail.com>

%post

    DEBIAN_FRONTEND=noninteractive

    # Install common dependencies
    apt-get update -y && apt-get install -y curl git build-essential python-is-python3

    # Deploy up MolProbity
    mkdir /opt/molprobity
    
    mkdir -p /opt/molprobity/modules/chem_data && cd /opt/molprobity/modules/chem_data
    git clone --depth 1 https://github.com/phenix-project/geostd.git
    git clone --depth 1 https://github.com/rlabduke/mon_lib.git
    git clone --depth 1 https://github.com/rlabduke/rotarama_data.git
    git clone --depth 1 https://github.com/rlabduke/cablam_data.git

    mkdir rama_z && cd rama_z
    curl -o top8000_rama_z_dict.pkl -L https://github.com/rlabduke/reference_data/raw/master/Top8000/rama_z/top8000_rama_z_dict.pkl

    cd /opt/molprobity
    curl -o bootstrap.py -L https://github.com/cctbx/cctbx_project/raw/master/libtbx/auto_build/bootstrap.py
    CI=true python3 bootstrap.py --builder=molprobity --nproc={{ NPROC }} --python=38 --use-conda && rm -rf bootstrap.py

%environment

    export PATH=/opt/molprobity/build/bin:${PATH}

%runscript

    exec "$@"
